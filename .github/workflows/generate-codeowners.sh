#!/usr/bin/env bash
set -eu

REPO_ROOT="$(git rev-parse --show-toplevel)"
CODEOWNERS_FILE="$REPO_ROOT/CODEOWNERS"

# Directories to exclude (not plugins)
EXCLUDED_DIRS=".git .github Bin"

# Load existing CODEOWNERS entries into a temp file for lookup
EXISTING_ENTRIES=$(mktemp)
trap "rm -f $EXISTING_ENTRIES" EXIT

if [[ -f "$CODEOWNERS_FILE" ]]; then
  grep -v '^#' "$CODEOWNERS_FILE" | grep -v '^$' > "$EXISTING_ENTRIES" || true
fi

# Start building the CODEOWNERS file
cat > "$CODEOWNERS_FILE" <<'EOF'
# This file is auto-generated by the generate-codeowners workflow.
# Do not edit manually.
#
# Each plugin directory is owned by the first person who committed to it.
# Fallback owners: @Ly-sec @ItsLemmy

* @Ly-sec @ItsLemmy

EOF

# Iterate over top-level directories that are plugins
for dir in "$REPO_ROOT"/*/; do
  dir_name=$(basename "$dir")

  # Skip excluded directories
  case " $EXCLUDED_DIRS " in
    *" $dir_name "*) continue ;;
  esac

  pattern="/$dir_name/"

  # If this plugin already has an entry in CODEOWNERS, keep it as-is
  existing_line=$(grep "^${pattern} " "$EXISTING_ENTRIES" 2>/dev/null || true)
  if [[ -n "$existing_line" ]]; then
    echo "$existing_line" >> "$CODEOWNERS_FILE"
    echo "  [KEPT]  $existing_line"
    continue
  fi

  # Find the first commit that touched this directory (oldest commit)
  # Use awk to get first line to avoid SIGPIPE with head
  first_author_email=$(git log --diff-filter=A --format='%ae' --reverse -- "$dir" 2>/dev/null | awk 'NR==1{print;exit}')

  if [[ -z "$first_author_email" ]]; then
    # Fallback: get the oldest commit author for this directory
    first_author_email=$(git log --format='%ae' --reverse -- "$dir" 2>/dev/null | awk 'NR==1{print;exit}')
  fi

  if [[ -z "$first_author_email" ]]; then
    echo "  [SKIP]  $pattern (no commits found)"
    continue
  fi

  # Try to extract the GitHub username from the email
  # GitHub noreply emails: user@users.noreply.github.com or 12345+user@users.noreply.github.com
  owner=""
  if echo "$first_author_email" | grep -qE '^([0-9]+\+)?[^@]+@users\.noreply\.github\.com$'; then
    # Extract username from noreply email
    github_username=$(echo "$first_author_email" | sed -E 's/^([0-9]+\+)?([^@]+)@users\.noreply\.github\.com$/\2/')
    owner="@$github_username"
  else
    # Fallback to the email address itself
    owner="$first_author_email"
  fi

  if [[ -n "$owner" ]]; then
    echo "$pattern $owner" >> "$CODEOWNERS_FILE"
    echo "  [NEW]   $pattern $owner"
  fi
done

echo ""
echo "CODEOWNERS file generated at $CODEOWNERS_FILE"
